name: Daily Quote
on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:  

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Fetch quote from API and update README
        run: |
          import urllib.request
          import json
          import re
          import datetime
          try:
              with urllib.request.urlopen("https://api.quotable.io/random", timeout=10) as response:
                  data = json.loads(response.read().decode())
                  quote_text = data["content"]
                  quote_author = data["author"]
          except Exception as e:
              quote_text = "The best way to predict the future is to invent it."
              quote_author = "Alan Kay"

          full_quote = f"¬´{quote_text}¬ª ‚Äî {quote_author}"
          today = datetime.datetime.now().strftime("%Y-%m-%d")
          new_block = f"## üìÖ –¶–∏—Ç–∞—Ç–∞ –¥–Ω—è ({today})\n\n> {full_quote}\n"
          try:
              with open("README.md", "r", encoding="utf-8") as f:
                  content = f.read()
          except FileNotFoundError:
              content = "# –ú–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π\n\n"
              
          pattern = r"(## üìÖ –¶–∏—Ç–∞—Ç–∞ –¥–Ω—è \(.*?\)\n\n> .*?\n)"
          if re.search(pattern, content, re.DOTALL):
              updated = re.sub(pattern, new_block, content, count=1, flags=re.DOTALL)
          else:
              lines = content.splitlines(keepends=True)
              if len(lines) > 1:
                  lines.insert(1, "\n" + new_block + "\n")
              else:
                  lines.append("\n" + new_block + "\n")
              updated = "".join(lines)
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(updated)

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "–¶–∏—Ç–∞—Ç–∞ –¥–Ω—è: $(date +%Y-%m-%d)"
          git push
